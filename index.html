<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국사 연도 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark mode background */
            color: #e2e8f0; /* Light text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            padding: 2rem;
            background-color: #2d3748; /* Card background */
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            background-color: #4a5568;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }
        .btn:hover {
            background-color: #636b77;
        }
        .btn-primary {
            background-color: #4299e1;
        }
        .btn-primary:hover {
            background-color: #3182ce;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .input-box {
            background-color: #4a5568;
            border: 1px solid #4a5568;
            color: #e2e8f0;
            padding: 0.5rem;
            border-radius: 0.5rem;
            width: 100%;
            -moz-appearance: textfield; /* Firefox */
        }
        /* Remove number input arrows for Webkit browsers (Chrome, Safari, etc.) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #result-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: bold;
        }
        .correct-bg {
            background-color: #10B981; /* green-500 */
        }
        .wrong-bg {
            background-color: #EF4444; /* red-500 */
        }
        /* Adjusted wrong-answer item background color */
        .wrong-item-bg {
            background-color: #7f1d1d; /* red-700 (softer) */
        }
        
        /* 새로운 날짜 입력 레이아웃 스타일 */
        #date-input-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem; /* 전체 요소 사이 간격 */
            margin-bottom: 2rem;
            flex-wrap: wrap; /* 작은 화면에서 줄바꿈 */
        }
        .date-part {
            display: flex;
            gap: 0.25rem; /* 년.월.일 사이 간격 */
            align-items: center;
        }
        .separator {
            font-size: 2rem;
            font-weight: 300;
        }
        .input-mini {
            width: 200px; /* 입력 박스 크기 조정 */
            padding: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <div id="main-menu" class="text-center">
        <h1 class="text-4xl font-bold mb-8">한국사 연도 퀴즈</h1>
        <div class="space-y-4">
            <button class="btn w-full text-lg" onclick="showScreen('timeline')">연표 보기</button>
            <button class="btn w-full text-lg" onclick="showQuizYearSelection(false)">문제 시작</button>
            <button class="btn w-full text-lg" onclick="showQuizWrongAnswers()">틀린 문제 풀기</button>
            <button class="btn w-full text-lg" onclick="showWrongAnswers()">틀린 연도 보기</button>
        </div>
    </div>

    <div id="timeline-view" class="hidden">
        <h2 class="text-2xl font-bold mb-4">전체 연표</h2>
        <div class="mb-4">
            <input type="text" id="timeline-search" placeholder="연도나 이름으로 검색..." class="input-box bg-gray-600 rounded-md">
        </div>
        <div id="timeline-list" class="space-y-2 max-h-96 overflow-y-auto pr-4"></div>
        <button class="btn mt-4" onclick="showScreen('menu')">메인 메뉴로 돌아가기</button>
    </div>

    <div id="year-selection-view" class="hidden text-center">
        <h2 class="text-2xl font-bold mb-4">퀴즈 연도 선택</h2>
        <p class="mb-4">시작 연도와 끝 연도를 선택하세요.</p>
        <div class="flex justify-around mb-8">
            <div class="text-center">
                <label for="startYear" class="block mb-2 text-lg">시작 연도</label>
                <select id="startYear" class="input-box bg-gray-600 rounded-md">
                    <option value="1940" selected>1940년대</option>
                    <option value="1950">1950년대</option>
                    <option value="1960">1960년대</option>
                    <option value="1970">1970년대</option>
                    <option value="1980">1980년대</option>
                    <option value="1990">1990년대</option>
                </select>
            </div>
            <div class="text-center">
                <label for="endYear" class="block mb-2 text-lg">끝 연도</label>
                <select id="endYear" class="input-box bg-gray-600 rounded-md">
                    <option value="1910">1910년대</option>
                    <option value="1920">1920년대</option>
                    <option value="1930">1930년대</option>
                    <option value="1940">1940년대</option>
                    <option value="1950">1950년대</option>
                    <option value="1960">1960년대</option>
                    <option value="1970">1970년대</option>
                    <option value="1980">1980년대</option>
                    <option value="1990" selected>1990년대</option>
                    <option value="2000">2000년대</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary w-full text-lg" onclick="startQuizFromSelection()">퀴즈 시작</button>
    </div>

    <div id="quiz-view" class="hidden text-center">
        <div class="flex justify-between items-start w-full mb-8">
            <div id="quiz-header">
                <p class="text-xl">문제 <span id="current-question"></span> / <span id="total-questions"></span></p>
                <p class="text-xl">맞춘 문제: <span id="correct-count"></span></p>
            </div>
            <button class="btn text-sm px-4 py-2" onclick="showScreen('menu')">메인 메뉴로 돌아가기</button>
        </div>
        <h3 id="event-name" class="text-3xl font-bold mb-8"></h3>
        
        <div id="date-input-display">
            <div id="start-date-part" class="date-part">
                <input type="number" id="start-year-input" placeholder="연도" class="input-box input-mini">
                <span id="start-year-dot" class="text-xl hidden">.</span>
                <input type="number" id="start-month-input" placeholder="월" class="input-box input-mini hidden">
                <span id="start-month-dot" class="text-xl hidden">.</span>
                <input type="number" id="start-day-input" placeholder="일" class="input-box input-mini hidden">
            </div>
            
            <span id="duration-separator" class="separator hidden">~</span>
            
            <div id="end-date-part" class="date-part hidden">
                <input type="number" id="end-year-input" placeholder="연도" class="input-box input-mini">
                <span id="end-year-dot" class="text-xl hidden">.</span>
                <input type="number" id="end-month-input" placeholder="월" class="input-box input-mini hidden">
                <span id="end-month-dot" class="text-xl hidden">.</span>
                <input type="number" id="end-day-input" placeholder="일" class="input-box input-mini hidden">
            </div>
        </div>
        
        <div id="quiz-actions" class="flex justify-center space-x-4">
            <button class="btn btn-primary text-lg" onclick="checkAnswer()">답안 확인 (Enter)</button>
        </div>
        <div id="result-message" class="hidden"></div>
    </div>

    <div id="final-score-view" class="hidden text-center">
        <h2 class="text-3xl font-bold mb-4">퀴즈 종료</h2>
        <p id="final-score-text" class="text-2xl mb-8"></p>
        <button class="btn text-lg" onclick="showScreen('menu')">메인 메뉴로</button>
    </div>

    <div id="wrong-answers-view" class="hidden">
        <h2 class="text-2xl font-bold mb-4">틀린 연도 목록</h2>
        <div id="wrong-list" class="space-y-2 max-h-96 overflow-y-auto pr-4"></div>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-x-4 sm:space-y-0 mt-4">
            <button class="btn flex-1" onclick="showScreen('menu')">메인 메뉴로 돌아가기</button>
            <button class="btn btn-primary bg-red-500 hover:bg-red-600 flex-1" onclick="resetWrongCounts()">틀린 연도 초기화</button>
        </div>
    </div>

</div>

<div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
    <div class="bg-gray-700 p-6 rounded-lg shadow-xl text-center">
        <p id="message-text" class="text-xl mb-4"></p>
        <button class="btn" onclick="hideMessage()">확인</button>
    </div>
</div>


<script>
    // 전역 변수 및 상태
    const events = [
        { name: "5.10 총선거", year: 1948, month: 5, day: 10, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "제헌 헌법 공포", year: 1948, month: 7, day: 17, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "대한민국 정부 수립 선포", year: 1948, month: 8, day: 15, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "농지 개혁법 제정", year: 1949, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "귀속 재산 처리법", year: 1949, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "반민특위 피습 사건", year: 1949, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "6.25 전쟁 시작", year: 1950, month: 6, day: 25, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "인천 상륙 작전", year: 1950, month: 9, day: 0, endYear: 0, endMonth: 0, endDay: 0 }, 
        { name: "1.4 후퇴", year: 1951, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "정전 협정 체결", year: 1953, month: 7, day: 27, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "발췌 개헌", year: 1952, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "부산 정치 파동", year: 1952, month: 5, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "사사오입 개헌", year: 1954, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "북한의 제 1차 5개년 계획", year: 1957, month: 0, day: 0, endYear: 1961, endMonth: 0, endDay: 0 },
        { name: "3.15 부정선거", year: 1960, month: 3, day: 15, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "4.19 혁명", year: 1960, month: 4, day: 19, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "대학교수단의 시국 선언", year: 1960, month: 4, day: 25, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "5.16 군사정변", year: 1961, month: 5, day: 16, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "제1차 경제 개발 5개년 계획", year: 1962, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "6.3 시위", year: 1964, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "베트남 파병", year: 1964, month: 0, day: 0, endYear: 1973, endMonth: 0, endDay: 0 },
        { name: "브라운 각서", year: 1966, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "제2차 경제 개발 5개년 계획", year: 1967, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "3선 개헌", year: 1969, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "새마을 운동", year: 1970, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "전태일 분신", year: 1970, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "광주 대단지 사건", year: 1971, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "제 3 4차 경제 개발 5개년 계획", year: 1972, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "남북 공동 성명", year: 1972, month: 7, day: 4, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "제 1차 석유 파동", year: 1973, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "미니스커트와 장발 단속", year: 1973, month: 0, day: 0, endYear: 1980, endMonth: 0, endDay: 0 },
        { name: "김급 조치 1호", year: 1974, month: 1, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "민청학련", year: 1974, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "인민 혁명단 재건 위원회 조작 사건", year: 1975, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "3.1 민주구국 선언", year: 1976, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "함평 고구마 사건", year: 1976, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "수출 100억 달러 달성", year: 1977, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "제 2차 석유 파동", year: 1978, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "부마 민주 항쟁", year: 1979, month: 10, day: 16, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "10.26 사태", year: 1979, month: 10, day: 26, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "12.12 군사 반란", year: 1979, month: 12, day: 12, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "서울의 봄", year: 1980, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "환경청 설치", year: 1980, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "5.18 민주화 운동", year: 1980, month: 5, day: 18, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "4.13 호헌 조치", year: 1987, month: 4, day: 13, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "이한열 최루탄 피격", year: 1987, month: 6, day: 9, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "국민 대회", year: 1987, month: 6, day: 10, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "면동 성당 농성", year: 1987, month: 6, day: 10, endYear: 1987, endMonth: 6, endDay: 15 },
        { name: "국민 평화 대행진", year: 1987, month: 6, day: 26, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "6.29 민주화 선언 발표", year: 1987, month: 6, day: 29, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "낙동강 페놀 오염 사건", year: 1991, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
        { name: "국가 환경 선언문", year: 1992, month: 0, day: 0, endYear: 0, endMonth: 0, endDay: 0 },
    ]

    let state = {
        screen: 'menu',
        questions: [],
        currentQuestionIndex: 0,
        score: 0,
        wrongCounts: {},
        wrongOnly: false
    };

    // DOM 요소 캐싱
    const screens = {
        menu: document.getElementById('main-menu'),
        timeline: document.getElementById('timeline-view'),
        yearSelection: document.getElementById('year-selection-view'),
        quiz: document.getElementById('quiz-view'),
        finalScore: document.getElementById('final-score-view'),
        wrongAnswers: document.getElementById('wrong-answers-view')
    };
    
    // 날짜 입력 필드 캐싱 (새로운 레이아웃에 맞춰 수정)
    const startYearInput = document.getElementById('start-year-input');
    const startMonthInput = document.getElementById('start-month-input');
    const startDayInput = document.getElementById('start-day-input');
    const endYearInput = document.getElementById('end-year-input');
    const endMonthInput = document.getElementById('end-month-input');
    const endDayInput = document.getElementById('end-day-input');
    
    // 구분자 및 컨테이너 캐싱
    const durationSeparator = document.getElementById('duration-separator');
    const endDatePart = document.getElementById('end-date-part');
    const startYearDot = document.getElementById('start-year-dot');
    const startMonthDot = document.getElementById('start-month-dot');
    const endYearDot = document.getElementById('end-year-dot');
    const endMonthDot = document.getElementById('end-month-dot');


    function showScreen(screenName) {
        for (const screen in screens) {
            screens[screen].classList.add('hidden');
        }
        screens[screenName].classList.remove('hidden');

        if (screenName === 'timeline') {
            document.getElementById('timeline-search').value = '';
            renderTimeline();
        } else if (screenName === 'wrongAnswers') {
            renderWrongAnswers();
        } else if (screenName === 'quiz') {
            startYearInput.focus();
        }
    }

    function showWrongAnswers() {
        showScreen('wrongAnswers');
    }

    function showMessage(message) {
        document.getElementById('message-text').textContent = message;
        document.getElementById('message-box').classList.remove('hidden');
    }

    function hideMessage() {
        document.getElementById('message-box').classList.add('hidden');
    }
    
    function formatEventDate(event) {
        // 기간이 있는 경우: endYear > 0
        if (event.endYear > 0) {
            const start = `${event.year}` + (event.month > 0 ? `.${event.month}` : '') + (event.day > 0 ? `.${event.day}` : '');
            const end = `${event.endYear}` + (event.endMonth > 0 ? `.${event.endMonth}` : '') + (event.endDay > 0 ? `.${event.endDay}` : '');
            return `${start} ~ ${end}`;
        }
        // 단일 사건인 경우
        let date = `${event.year}`;
        if (event.month > 0) date += `.${event.month}`;
        if (event.day > 0) date += `.${event.day}`;
        return date;
    }


    function renderTimeline(searchTerm = '') {
        const timelineList = document.getElementById('timeline-list');
        const normalizedSearchTerm = searchTerm.toLowerCase().trim();
        
        let eventsToRender = events;

        if (normalizedSearchTerm) {
            eventsToRender = events.filter(event => {
                const eventName = event.name.toLowerCase();
                const eventDate = formatEventDate(event);
                
                return eventName.includes(normalizedSearchTerm) || 
                       eventDate.includes(normalizedSearchTerm);
            });
        }
        
        if (eventsToRender.length === 0) {
            timelineList.innerHTML = `<p class="text-center text-gray-400">검색 결과가 없습니다.</p>`;
            return;
        }
        
        timelineList.innerHTML = eventsToRender.map((event, index) => {
            const date = formatEventDate(event);
            return `<div class="p-2 bg-gray-700 rounded-lg">
                        <p class="font-bold">${event.name}</p>
                        <p class="text-sm text-gray-400">${date}</p>
                    </div>`;
        }).join('');
    }

    function renderWrongAnswers() {
        loadWrongCounts();
        const wrongList = document.getElementById('wrong-list');
        
        let wrongEvents = events.filter(event => state.wrongCounts[event.name] > 0);

        if (wrongEvents.length === 0) {
            wrongList.innerHTML = `<p class="text-center text-gray-400">틀린 문제가 없습니다!</p>`;
            return;
        }

        wrongEvents = wrongEvents.map(event => ({
            ...event,
            wrongCount: state.wrongCounts[event.name]
        }));
        
        wrongEvents.sort((a, b) => b.wrongCount - a.wrongCount); 

        wrongList.innerHTML = wrongEvents.map(event => {
            const date = formatEventDate(event);
            return `<div class="p-2 wrong-item-bg rounded-lg">
                        <p class="font-bold">${event.name}</p>
                        <p class="text-sm text-gray-300">정답: ${date} - 틀린 횟수: ${event.wrongCount}</p>
                    </div>`;
        }).join('');
    }

    function resetWrongCounts() {
        state.wrongCounts = {};
        saveWrongCounts();
        renderWrongAnswers();
        showMessage('틀린 연도 기록이 모두 초기화되었습니다!');
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function showQuizYearSelection(wrongOnly) {
        state.wrongOnly = wrongOnly;
        showScreen('yearSelection');
    }

    function showQuizWrongAnswers() {
        loadWrongCounts();
        const wrongEvents = events.filter(event => state.wrongCounts[event.name] > 0);
        if (wrongEvents.length === 0) {
            showMessage('틀린 문제가 없습니다!');
            return;
        }
        state.wrongOnly = true;
        startQuiz(wrongEvents);
    }

    function startQuizFromSelection() {
        const startYear = parseInt(document.getElementById('startYear').value);
        const endYearDecadeStart = parseInt(document.getElementById('endYear').value);
        const endYearInclusive = endYearDecadeStart + 9;

        if (endYearDecadeStart < startYear) {
            showMessage('끝 연도 선택은 시작 연도보다 이후여야 합니다.');
            return;
        }
        
        let filteredEvents = events.filter(event => event.year >= startYear && event.year <= endYearInclusive);
        
        if (state.wrongOnly) {
             filteredEvents = filteredEvents.filter(event => state.wrongCounts[event.name] > 0);
        }
        
        if (filteredEvents.length === 0) {
            showMessage(`선택된 연도(${startYear} ~ ${endYearInclusive}년)에 맞는 문제가 없습니다.`);
            return;
        }
        
        startQuiz(filteredEvents);
    }

    function startQuiz(filteredEvents) {
        state.questions = [...filteredEvents];
        shuffleArray(state.questions);
        state.currentQuestionIndex = 0;
        state.score = 0;
        
        document.getElementById('total-questions').textContent = state.questions.length;
        document.getElementById('correct-count').textContent = state.score;

        showScreen('quiz');
        renderQuestion();
    }

    function renderQuestion() {
        if (state.currentQuestionIndex >= state.questions.length) {
            showFinalScore();
            return;
        }

        const currentEvent = state.questions[state.currentQuestionIndex];
        document.getElementById('event-name').textContent = currentEvent.name;
        document.getElementById('current-question').textContent = state.currentQuestionIndex + 1;
        
        // 입력 필드 초기화
        startYearInput.value = '';
        startMonthInput.value = '';
        startDayInput.value = '';
        endYearInput.value = '';
        endMonthInput.value = '';
        endDayInput.value = '';

        const isDurationEvent = currentEvent.endYear > 0;

        // 1. 기간 구분자와 끝 날짜 입력 영역 표시/숨김
        durationSeparator.classList.toggle('hidden', !isDurationEvent);
        endDatePart.classList.toggle('hidden', !isDurationEvent);

        // 2. 시작 날짜 입력 필드 동적 표시/숨김
        startMonthInput.classList.toggle('hidden', currentEvent.month === 0);
        startDayInput.classList.toggle('hidden', currentEvent.day === 0);
        startYearDot.classList.toggle('hidden', currentEvent.month === 0);
        startMonthDot.classList.toggle('hidden', currentEvent.day === 0 || currentEvent.month === 0);

        // 3. 끝 날짜 입력 필드 동적 표시/숨김 (기간 사건일 경우)
        if (isDurationEvent) {
            endMonthInput.classList.toggle('hidden', currentEvent.endMonth === 0);
            endDayInput.classList.toggle('hidden', currentEvent.endDay === 0);
            endYearDot.classList.toggle('hidden', currentEvent.endMonth === 0);
            endMonthDot.classList.toggle('hidden', currentEvent.endDay === 0 || currentEvent.endMonth === 0);
        }

        // 결과 메시지 초기화
        const resultMessage = document.getElementById('result-message');
        resultMessage.classList.add('hidden');
        resultMessage.classList.remove('correct-bg', 'wrong-bg');

        // 기존의 '다음 문제' 버튼이 있다면 제거하고 '답안 확인' 버튼만 유지
        const quizActions = document.getElementById('quiz-actions');
        quizActions.innerHTML = '<button class="btn btn-primary text-lg" onclick="checkAnswer()">답안 확인 (Enter)</button>';
        
        startYearInput.focus();
    }

    function checkAnswer() {
        const currentEvent = state.questions[state.currentQuestionIndex];
        const isDurationEvent = currentEvent.endYear > 0;

        // 시작 날짜 입력 값 (값이 없으면 0으로 처리)
        const sY = parseInt(startYearInput.value) || 0;
        const sM = parseInt(startMonthInput.value) || 0;
        const sD = parseInt(startDayInput.value) || 0;
        
        // 끝 날짜 입력 값 (기간 사건일 경우에만 필요, 값이 없으면 0으로 처리)
        let eY = 0, eM = 0, eD = 0;
        if (isDurationEvent) {
            eY = parseInt(endYearInput.value) || 0;
            eM = parseInt(endMonthInput.value) || 0;
            eD = parseInt(endDayInput.value) || 0;
        }

        const resultMessage = document.getElementById('result-message');
        
        if (document.getElementById('next-question-btn')) return;

        // 필수 입력 필드 (시작 연도) 확인
        if (sY === 0) {
            showMessage("시작 연도를 숫자로 입력해주세요.");
            return;
        }

        let isCorrect;
        
        if (isDurationEvent) {
            // 기간 사건 정답 확인 로직
            const startCorrect = sY === currentEvent.year &&
                                 (currentEvent.month === 0 || sM === currentEvent.month) &&
                                 (currentEvent.day === 0 || sD === currentEvent.day);
            
            const endCorrect = eY === currentEvent.endYear &&
                               (currentEvent.endMonth === 0 || eM === currentEvent.endMonth) &&
                               (currentEvent.endDay === 0 || eD === currentEvent.endDay);
                               
            isCorrect = startCorrect && endCorrect;
            
        } else {
            // 단일 사건 정답 확인 로직
            const monthCheck = currentEvent.month === 0 || sM === currentEvent.month;
            const dayCheck = currentEvent.day === 0 || sD === currentEvent.day;
            
            isCorrect = sY === currentEvent.year && monthCheck && dayCheck;
        }
        
        // 정답 메시지 구성
        let correctDetailString = `정답: ${formatEventDate(currentEvent)}`;


        if (isCorrect) {
            state.score++;
            document.getElementById('correct-count').textContent = state.score;
            resultMessage.textContent = '정답입니다.';
            resultMessage.classList.add('correct-bg');
        } else {
            resultMessage.innerHTML = `오답입니다.<br>${correctDetailString}`;
            resultMessage.classList.add('wrong-bg');
            state.wrongCounts[currentEvent.name] = (state.wrongCounts[currentEvent.name] || 0) + 1;
            saveWrongCounts();
        }

        resultMessage.classList.remove('hidden');

        // '다음 문제' 버튼 생성
        const quizActions = document.getElementById('quiz-actions');
        quizActions.innerHTML = ''; 
        const nextBtn = document.createElement('button');
        nextBtn.id = 'next-question-btn';
        nextBtn.className = 'btn btn-primary text-lg';
        nextBtn.textContent = '다음 문제(space)';
        nextBtn.onclick = () => {
            state.currentQuestionIndex++;
            renderQuestion();
        };
        quizActions.appendChild(nextBtn);
    }

    function showFinalScore() {
        const finalScoreText = document.getElementById('final-score-text');
        const totalQuestions = state.questions.length;
        finalScoreText.textContent = `${totalQuestions} 문제 중 ${state.score} 문제를 맞췄습니다.`;
        showScreen('finalScore');
    }

    function saveWrongCounts() {
        localStorage.setItem('wrongCounts', JSON.stringify(state.wrongCounts));
    }

    function loadWrongCounts() {
        const storedCounts = localStorage.getItem('wrongCounts');
        if (storedCounts) {
            state.wrongCounts = JSON.parse(storedCounts);
        } else {
            state.wrongCounts = {};
        }
    }

    // 다음 포커스 이동 로직 (Helper)
    function moveToNextInput(currentInput, currentEvent) {
        const isDurationEvent = currentEvent.endYear > 0;

        if (currentInput === startYearInput) {
            if (currentEvent.month > 0) startMonthInput.focus();
            else if (currentEvent.day > 0) startDayInput.focus();
            else if (isDurationEvent) endYearInput.focus();
            else checkAnswer();
        } else if (currentInput === startMonthInput) {
            if (currentEvent.day > 0) startDayInput.focus();
            else if (isDurationEvent) endYearInput.focus();
            else checkAnswer();
        } else if (currentInput === startDayInput) {
            if (isDurationEvent) endYearInput.focus();
            else checkAnswer();
        } else if (currentInput === endYearInput) {
            if (currentEvent.endMonth > 0) endMonthInput.focus();
            else if (currentEvent.endDay > 0) endDayInput.focus();
            else checkAnswer();
        } else if (currentInput === endMonthInput) {
            if (currentEvent.endDay > 0) endDayInput.focus();
            else checkAnswer();
        } else if (currentInput === endDayInput) {
            checkAnswer();
        }
    }

    // 키보드 이벤트 리스너 통합 (Enter 키)
    document.querySelectorAll('#date-input-display input[type="number"]').forEach(input => {
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                
                const currentEvent = state.questions[state.currentQuestionIndex];
                const isAnswered = document.getElementById('next-question-btn');
                
                if(isAnswered) {
                    isAnswered.click();
                } else {
                    moveToNextInput(this, currentEvent); 
                }
            }
        });
    });
    
    // 전체 문서에 키보드 이벤트 리스너 추가 (스페이스바 누르면 다음 문제로)
    document.addEventListener('keydown', function(event) {
        const nextBtn = document.getElementById('next-question-btn');
        if (event.key === ' ' && nextBtn) {
            event.preventDefault();
            nextBtn.click();
        }
    });

    // Add event listener for the search input
    document.getElementById('timeline-search').addEventListener('input', (e) => {
        renderTimeline(e.target.value);
    });
    
    // 초기화 및 시작
    loadWrongCounts();
    showScreen('menu');

</script>
</body>
</html>
