<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국사 연도 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark mode background */
            color: #e2e8f0; /* Light text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            padding: 2rem;
            background-color: #2d3748; /* Card background */
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            background-color: #4a5568;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }
        .btn:hover {
            background-color: #636b77;
        }
        .btn-primary {
            background-color: #4299e1;
        }
        .btn-primary:hover {
            background-color: #3182ce;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .input-box {
            background-color: #4a5568;
            border: 1px solid #4a5568;
            color: #e2e8f0;
            padding: 0.5rem;
            border-radius: 0.5rem;
            width: 100%;
            -moz-appearance: textfield; /* Firefox */
        }
        /* Remove number input arrows for Webkit browsers (Chrome, Safari, etc.) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #result-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: bold;
        }
        .correct-bg {
            background-color: #10B981; /* green-500 */
        }
        .wrong-bg {
            background-color: #EF4444; /* red-500 */
        }
        /* Adjusted wrong-answer item background color */
        .wrong-item-bg {
            background-color: #7f1d1d; /* red-700 (softer) */
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <div id="main-menu" class="text-center">
        <h1 class="text-4xl font-bold mb-8">한국사 연도 퀴즈</h1>
        <div class="space-y-4">
            <button class="btn w-full text-lg" onclick="showScreen('timeline')">연표 보기</button>
            <button class="btn w-full text-lg" onclick="showQuizYearSelection(false)">문제 시작</button>
            <button class="btn w-full text-lg" onclick="showQuizWrongAnswers()">틀린 문제 풀기</button>
            <button class="btn w-full text-lg" onclick="showWrongAnswers()">틀린 연도 보기</button>
        </div>
    </div>

    <div id="timeline-view" class="hidden">
        <h2 class="text-2xl font-bold mb-4">전체 연표</h2>
        <div class="mb-4">
            <input type="text" id="timeline-search" placeholder="연도나 이름으로 검색..." class="input-box bg-gray-600 rounded-md">
        </div>
        <div id="timeline-list" class="space-y-2 max-h-96 overflow-y-auto pr-4"></div>
        <button class="btn mt-4" onclick="showScreen('menu')">메인 메뉴로 돌아가기</button>
    </div>

    <div id="year-selection-view" class="hidden text-center">
        <h2 class="text-2xl font-bold mb-4">퀴즈 연도 선택</h2>
        <p class="mb-4">시작 연도와 끝 연도를 선택하세요.</p>
        <div class="flex justify-around mb-8">
            <div class="text-center">
                <label for="startYear" class="block mb-2 text-lg">시작 연도</label>
                <select id="startYear" class="input-box bg-gray-600 rounded-md">
                    <option value="1940" selected>1940년대</option>
                    <option value="1950">1950년대</option>
                    <option value="1960">1960년대</option>
                    <option value="1970">1970년대</option>
                    <option value="1980">1980년대</option>
                    <option value="1990">1990년대</option>
                </select>
            </div>
            <div class="text-center">
                <label for="endYear" class="block mb-2 text-lg">끝 연도</label>
                <select id="endYear" class="input-box bg-gray-600 rounded-md">
                    <option value="1950">1950년대</option>
                    <option value="1960">1960년대</option>
                    <option value="1970">1970년대</option>
                    <option value="1980">1980년대</option>
                    <option value="1990" selected>1990년대</option>
                    <option value="2000">2000년대</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary w-full text-lg" onclick="startQuizFromSelection()">퀴즈 시작</button>
    </div>

    <div id="quiz-view" class="hidden text-center">
        <div class="flex justify-between items-start w-full mb-8">
            <div id="quiz-header">
                <p class="text-xl">문제 <span id="current-question"></span> / <span id="total-questions"></span></p>
                <p class="text-xl">맞춘 문제: <span id="correct-count"></span></p>
            </div>
            <button class="btn text-sm px-4 py-2" onclick="showScreen('menu')">메인 메뉴로 돌아가기</button>
        </div>
        <h3 id="event-name" class="text-3xl font-bold mb-8"></h3>
        <div class="input-group mb-8 w-full max-w-sm mx-auto">
            <input type="number" id="year-input" placeholder="연도를 입력하세요 (예: 1919)" class="input-box text-center">
            <input type="number" id="month-input" placeholder="월을 입력하세요 (선택 사항)" class="input-box text-center">
        </div>
        <div id="quiz-actions" class="flex justify-center space-x-4">
            <button class="btn btn-primary text-lg" onclick="checkAnswer()">답안 확인 (Enter)</button>
        </div>
        <div id="result-message" class="hidden"></div>
    </div>

    <div id="final-score-view" class="hidden text-center">
        <h2 class="text-3xl font-bold mb-4">퀴즈 종료</h2>
        <p id="final-score-text" class="text-2xl mb-8"></p>
        <button class="btn text-lg" onclick="showScreen('menu')">메인 메뉴로</button>
    </div>

    <div id="wrong-answers-view" class="hidden">
        <h2 class="text-2xl font-bold mb-4">틀린 연도 목록</h2>
        <div id="wrong-list" class="space-y-2 max-h-96 overflow-y-auto pr-4"></div>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-x-4 sm:space-y-0 mt-4">
            <button class="btn flex-1" onclick="showScreen('menu')">메인 메뉴로 돌아가기</button>
            <button class="btn btn-primary bg-red-500 hover:bg-red-600 flex-1" onclick="resetWrongCounts()">틀린 연도 초기화</button>
        </div>
    </div>

</div>

<div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
    <div class="bg-gray-700 p-6 rounded-lg shadow-xl text-center">
        <p id="message-text" class="text-xl mb-4"></p>
        <button class="btn" onclick="hideMessage()">확인</button>
    </div>
</div>


<script>
    // 전역 변수 및 상태
    const events = [
        { name: "5.10 총선거", year: 1948, month: 4 },
    { name: "제헌 헌법 공포", year: 1948, month: 6 },
    { name: "대한민국 정부 수립 선포", year: 1948, month: 7 },
    { name: "농지 개혁법 제정", year: 1949, month: 5 },
    { name: "귀속 재산 처리법", year: 1949, month: 11 },
    { name: "반민특위 피습 사건", year: 1949, month: 4 },
    { name: "6.25 전쟁 시작", year: 1950, month: 5 },
    { name: "인천 상륙 작전", year: 1950, month: 8 },
    { name: "1.4 후퇴", year: 1951, month: 0 },
    { name: "정전 협정 체결", year: 1953, month: 6 },
    { name: "발췌 개헌", year: 1952, month: 6 },
    { name: "부산 정치 파동", year: 1952, month: 4 },
    { name: "사사오입 개헌", year: 1954, month: 10 },
    { name: "북한의 제 1차 5개년 계획", year: 1957, month: 0 },
    { name: "3.15 부정선거", year: 1960, month: 2 },
    { name: "4.19 혁명", year: 1960, month: 3 },
    { name: "대학교수단의 시국 선언", year: 1960, month: 3 },
    { name: "5.16 군사정변", year: 1961, month: 4 },
    { name: "6.3 시위", year: 1964, month: 5 },
    { name: "베트남 파병", year: 1964, month: 8 },
    { name: "브라운 각서", year: 1966, month: 11 },
    { name: "3선 개헌", year: 1969, month: 8 },
    { name: "남북 공동 성명", year: 1972, month: 6 },
    { name: "김급 조치 1호", year: 1974, month: 0 },
    { name: "민청학련", year: 1974, month: 3 },
    { name: "인민 혁명단 재건 위원회 조작 사건", year: 1975, month: 3 },
    { name: "3.1 민주구국 선언", year: 1976, month: 2 },
    { name: "부마 민주 항쟁", year: 1979, month: 9 },
    { name: "10.26 사태", year: 1979, month: 9 },
    { name: "12.12 군사 반란", year: 1979, month: 11 },
    { name: "서울의 봄", year: 1980, month: 2 },
    { name: "5.18 민주화 운동", year: 1980, month: 4 },
    { name: "4.13 호헌 조치", year: 1987, month: 3 },
    { name: "이한열 최루탄 피격", year: 1987, month: 5 },
    { name: "국민 대회", year: 1987, month: 5 },
    { name: "면동 성당 농성", year: 1987, month: 5 },
    { name: "국민 평화 대행진", year: 1987, month: 5 },
    { name: "6.29 민주화 선언 발표", year: 1987, month: 5 },
    { name: "제1차 경제 개발 5개년 계획", year: 1962, month: 0 },
    { name: "제2차 경제 개발 5개년 계획", year: 1967, month: 0 },
    { name: "제 3 4차 경제 개발 5개년 계획", year: 1972, month: 0 },
    { name: "제 1차 석유 파동", year: 1973, month: 9 },
    { name: "수출 100억 달러 달성", year: 1977, month: 11 },
    { name: "제 2차 석유 파동", year: 1978, month: 11 },
    { name: "광주 대단지 사건", year: 1971, month: 7 },
    { name: "새마을 운동", year: 1970, month: 3 },
    { name: "함평 고구마 사건", year: 1976, month: 8 },
    { name: "전태일 분신", year: 1970, month: 10 },
    { name: "낙동강 페놀 오염 사건", year: 1991, month: 2 },
    { name: "환경청 설치", year: 1980, month: 0 },
    { name: "국가 환경 선언문", year: 1992, month: 5 },
    { name: "미니스커트와 장발 단속", year: 1973, month: 2 }
    ];

    let state = {
        screen: 'menu',
        questions: [],
        currentQuestionIndex: 0,
        score: 0,
        wrongCounts: {},
        wrongOnly: false
    };

    // DOM 요소 캐싱
    const screens = {
        menu: document.getElementById('main-menu'),
        timeline: document.getElementById('timeline-view'),
        yearSelection: document.getElementById('year-selection-view'),
        quiz: document.getElementById('quiz-view'),
        finalScore: document.getElementById('final-score-view'),
        wrongAnswers: document.getElementById('wrong-answers-view')
    };

    function showScreen(screenName) {
        for (const screen in screens) {
            screens[screen].classList.add('hidden');
        }
        screens[screenName].classList.remove('hidden');

        if (screenName === 'timeline') {
            document.getElementById('timeline-search').value = '';
            renderTimeline();
        } else if (screenName === 'wrongAnswers') {
            renderWrongAnswers();
        } else if (screenName === 'quiz') {
            // 초기 퀴즈 화면 진입 시에도 포커스 설정
            // 다음 문제로 넘어가는 것은 renderQuestion에서 처리됩니다.
            document.getElementById('year-input').focus();
        }
    }

    // 틀린 연도 목록을 보여주는 기능 추가
    function showWrongAnswers() {
        showScreen('wrongAnswers');
    }

    // 메시지 창을 보여주는 함수
    function showMessage(message) {
        document.getElementById('message-text').textContent = message;
        document.getElementById('message-box').classList.remove('hidden');
    }

    // 메시지 창을 숨기는 함수
    function hideMessage() {
        document.getElementById('message-box').classList.add('hidden');
    }

    // 검색 기능 로직이 추가되고, 초기화 오류가 수정된 renderTimeline 함수
    function renderTimeline(searchTerm = '') {
        const timelineList = document.getElementById('timeline-list');
        const normalizedSearchTerm = searchTerm.toLowerCase().trim();
        
        // 검색어에 따라 이벤트 필터링
        let eventsToRender = events; // <<-- 이벤트 목록 초기화 수정 완료

        if (normalizedSearchTerm) {
            eventsToRender = events.filter(event => {
                const eventName = event.name.toLowerCase();
                const eventYear = String(event.year);
                // 연도와 월을 조합한 날짜 형식도 검색 가능하도록 처리
                const eventDate = event.month !== 0 ? `${event.year}.${event.month}` : `${event.year}`;
                
                // 이벤트 이름, 연도, 날짜(연도.월) 모두 검색
                return eventName.includes(normalizedSearchTerm) || 
                       eventYear.includes(normalizedSearchTerm) ||
                       eventDate.includes(normalizedSearchTerm);
            });
        }
        
        if (eventsToRender.length === 0) {
            timelineList.innerHTML = `<p class="text-center text-gray-400">검색 결과가 없습니다.</p>`;
            return;
        }
        
        timelineList.innerHTML = eventsToRender.map((event, index) => {
            const date = event.month !== 0 ? `${event.year}.${event.month}` : `${event.year}`;
            return `<div class="p-2 bg-gray-700 rounded-lg">
                        <p class="font-bold">${event.name}</p>
                        <p class="text-sm text-gray-400">${date}</p>
                    </div>`;
        }).join('');
    }

    function renderWrongAnswers() {
        loadWrongCounts();
        const wrongList = document.getElementById('wrong-list');
        
        let wrongEvents = events.filter(event => state.wrongCounts[event.name] > 0);

        if (wrongEvents.length === 0) {
            wrongList.innerHTML = `<p class="text-center text-gray-400">틀린 문제가 없습니다!</p>`;
            return;
        }

        // Add wrongCount to each event object for sorting and display
        wrongEvents = wrongEvents.map(event => ({
            ...event,
            wrongCount: state.wrongCounts[event.name]
        }));
        
        // Now sort correctly based on the new wrongCount property
        wrongEvents.sort((a, b) => b.wrongCount - a.wrongCount); 

        // 틀린 문제 목록에 `wrong-item-bg` 클래스 적용
        wrongList.innerHTML = wrongEvents.map(event => {
            const date = event.month !== 0 ? `${event.year}.${event.month}` : `${event.year}`;
            return `<div class="p-2 wrong-item-bg rounded-lg">
                        <p class="font-bold">${event.name}</p>
                        <p class="text-sm text-gray-300">정답: ${date} - 틀린 횟수: ${event.wrongCount}</p>
                    </div>`;
        }).join('');
    }

    // 틀린 횟수를 초기화하는 함수 추가
    function resetWrongCounts() {
        state.wrongCounts = {};
        saveWrongCounts();
        renderWrongAnswers();
        showMessage('틀린 연도 기록이 모두 초기화되었습니다!');
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function showQuizYearSelection(wrongOnly) {
        state.wrongOnly = wrongOnly;
        showScreen('yearSelection');
    }

    function showQuizWrongAnswers() {
        loadWrongCounts();
        const wrongEvents = events.filter(event => state.wrongCounts[event.name] > 0);
        if (wrongEvents.length === 0) {
            showMessage('틀린 문제가 없습니다!');
            return;
        }
        state.wrongOnly = true;
        startQuiz(wrongEvents);
    }

    function startQuizFromSelection() {
        const startYear = parseInt(document.getElementById('startYear').value);
        // 드롭다운의 값은 '1940'처럼 시작 연도를 나타내므로, 
        // 해당 10년대를 모두 포함하려면 '1949'처럼 9를 더한 연도까지 포함하는 것이 일반적입니다.
        // 하지만 사용자 경험을 위해 선택된 '끝 연도'의 10년 단위까지 포함되도록
        // (예: 끝 연도 1950년대 선택 시 1959년까지 포함) 조건을 수정합니다.
        const endYearDecadeStart = parseInt(document.getElementById('endYear').value);
        const endYearInclusive = endYearDecadeStart + 9; // 해당 10년의 마지막 해

        if (endYearDecadeStart < startYear) {
            showMessage('끝 연도 선택은 시작 연도보다 이후여야 합니다.');
            return;
        }
        
        // 수정: event.year가 선택된 시작 연도(10년 단위) 이상 AND 끝 연도(10년 단위 + 9) 이하인 경우 포함
        let filteredEvents = events.filter(event => event.year >= startYear && event.year <= endYearInclusive);
        
        if (state.wrongOnly) {
             filteredEvents = filteredEvents.filter(event => state.wrongCounts[event.name] > 0);
        }
        
        if (filteredEvents.length === 0) {
            showMessage(`선택된 연도(${startYear} ~ ${endYearInclusive}년)에 맞는 문제가 없습니다.`);
            return;
        }
        
        startQuiz(filteredEvents);
    }

    function startQuiz(filteredEvents) {
        state.questions = [...filteredEvents];
        shuffleArray(state.questions);
        state.currentQuestionIndex = 0;
        state.score = 0;
        
        document.getElementById('total-questions').textContent = state.questions.length;
        document.getElementById('correct-count').textContent = state.score;

        showScreen('quiz');
        renderQuestion();
    }

    function renderQuestion() {
        if (state.currentQuestionIndex >= state.questions.length) {
            showFinalScore();
            return;
        }

        const currentEvent = state.questions[state.currentQuestionIndex];
        document.getElementById('event-name').textContent = currentEvent.name;
        document.getElementById('current-question').textContent = state.currentQuestionIndex + 1;
        document.getElementById('year-input').value = '';
        document.getElementById('month-input').value = '';
        
        // 월이 없는 문제인 경우 월 입력란 숨기기
        if (currentEvent.month === 0) {
            document.getElementById('month-input').style.display = 'none';
        } else {
            document.getElementById('month-input').style.display = 'block';
        }

        // 결과 메시지 초기화
        const resultMessage = document.getElementById('result-message');
        resultMessage.classList.add('hidden');
        resultMessage.classList.remove('correct-bg', 'wrong-bg');

        // 기존의 '다음 문제' 버튼이 있다면 제거하고 '답안 확인' 버튼만 유지
        const quizActions = document.getElementById('quiz-actions');
        quizActions.innerHTML = '<button class="btn btn-primary text-lg" onclick="checkAnswer()">답안 확인 (Enter)</button>';
        
        // 다음 문제로 넘어갈 때 무조건 년도 입력 필드에 포커스를 맞춥니다.
        document.getElementById('year-input').focus();
    }

    function checkAnswer() {
        const currentEvent = state.questions[state.currentQuestionIndex];
        const yearInput = parseInt(document.getElementById('year-input').value);
        const monthInput = parseInt(document.getElementById('month-input').value) || 0;
        const resultMessage = document.getElementById('result-message');
        
        // 이미 답변이 처리되었는지 확인
        if (document.getElementById('next-question-btn')) return;

        // 숫자가 입력되지 않은 경우 처리
        if (isNaN(yearInput)) {
            showMessage("연도를 숫자로 입력해주세요.");
            return;
        }

        const isCorrect = yearInput === currentEvent.year && (currentEvent.month === 0 || monthInput === currentEvent.month);

        if (isCorrect) {
            state.score++;
            document.getElementById('correct-count').textContent = state.score;
            resultMessage.textContent = '정답입니다.';
            resultMessage.classList.add('correct-bg');
        } else {
            resultMessage.innerHTML = `오답입니다.<br>정답: ${currentEvent.year}${currentEvent.month !== 0 ? `년 ${currentEvent.month}월` : '년'}`;
            resultMessage.classList.add('wrong-bg');
            state.wrongCounts[currentEvent.name] = (state.wrongCounts[currentEvent.name] || 0) + 1;
            saveWrongCounts();
        }

        resultMessage.classList.remove('hidden');

        // '다음 문제' 버튼 생성
        const quizActions = document.getElementById('quiz-actions');
        quizActions.innerHTML = ''; // 기존 '답안 확인' 버튼 제거
        const nextBtn = document.createElement('button');
        nextBtn.id = 'next-question-btn';
        nextBtn.className = 'btn btn-primary text-lg';
        nextBtn.textContent = '다음 문제(space)';
        nextBtn.onclick = () => {
            state.currentQuestionIndex++;
            renderQuestion();
        };
        quizActions.appendChild(nextBtn);
    }

    function showFinalScore() {
        const finalScoreText = document.getElementById('final-score-text');
        const totalQuestions = state.questions.length;
        finalScoreText.textContent = `${totalQuestions} 문제 중 ${state.score} 문제를 맞췄습니다.`;
        showScreen('finalScore');
    }

    function saveWrongCounts() {
        localStorage.setItem('wrongCounts', JSON.stringify(state.wrongCounts));
    }

    function loadWrongCounts() {
        const storedCounts = localStorage.getItem('wrongCounts');
        if (storedCounts) {
            state.wrongCounts = JSON.parse(storedCounts);
        } else {
            state.wrongCounts = {};
        }
    }

    // 연도 입력 필드에 키보드 이벤트 리스너 추가 (엔터 키 누르면 월 입력란으로 이동 또는 답안 확인)
    document.getElementById('year-input').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // 기본 폼 제출 방지

            const currentEvent = state.questions[state.currentQuestionIndex];
            const isAnswered = document.getElementById('next-question-btn');
            
            if(isAnswered) {
                // 이미 답을 맞췄으면 다음 문제로
                isAnswered.click();
            } else if (currentEvent.month !== 0) {
                // 월 입력이 필요하면 월 입력란으로 포커스 이동
                document.getElementById('month-input').focus();
            } else {
                // 월 입력이 필요 없으면 답안 확인
                checkAnswer();
            }
        }
    });

    // 월 입력 필드에 키보드 이벤트 리스너 추가 (엔터 키 누르면 답안 확인)
    document.getElementById('month-input').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // 기본 폼 제출 방지
            const isAnswered = document.getElementById('next-question-btn');
            if(isAnswered) {
                // 이미 답을 맞췄으면 다음 문제로
                isAnswered.click();
            } else {
                checkAnswer();
            }
        }
    });
    
    // 전체 문서에 키보드 이벤트 리스너 추가 (스페이스바 누르면 다음 문제로)
    document.addEventListener('keydown', function(event) {
        const nextBtn = document.getElementById('next-question-btn');
        if (event.key === ' ' && nextBtn) {
            event.preventDefault();
            nextBtn.click();
        }
    });

    // Add event listener for the search input
    document.getElementById('timeline-search').addEventListener('input', (e) => {
        renderTimeline(e.target.value);
    });
    
    // 초기화 및 시작
    loadWrongCounts();
    showScreen('menu');

</script>
</body>
</html>
